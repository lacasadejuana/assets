<!DOCTYPE html>
<html lang="en">

<head>
     <meta name="csrf" content="" /></head>

    <title>Mape Frame index.html</title>

<body>
    <script src="./js/init_public_map.js"></script>
    <!-- ======== main-wrapper start =========== -->
    <main class="main-wrapper ml-0 collapsed no_transitions public-mapindex">
        <link rel="stylesheet" href="./css/app.css"/>
        


        <!-- ========== section start ========== -->
        <section class="section max-w-136rem mx-auto" id="outer_section">
            <div class="container-fluid pl-2 px-0" x-data='{}'>

        


                <article class="outer_container" id="barebone_container">
                    <div class="w-full" x-data="{
                        codigo_interno: null,
                        extent: null,
                        mapDialogOpen:false,
                        init() {
                    
                            this.importComponent();
                            let qs = new URL(location.href)
                            if (qs.searchParams.get('codigo_interno')) {
                                this.codigo_interno = qs.searchParams.get('codigo_interno')
                                this.$store.public_maps.codigo_interno=this.codigo_interno;
                            }
                            if (qs.searchParams.get('extent')) {
                    
                                this.extent = qs.searchParams.get('extent')
                    
                                // this.full_map=false;
                                this.full_map = false;
                                this.$store.public_maps.full_map = this.full_map;
                            } else {
                                this.full_map = true
                                this.$store.public_maps.skipMapCreation = true
                                this.$store.public_maps.full_map = this.full_map;
                            }
                    
                        },
                        full_map: false,
                    
                        componentsReady: false,
                        mapDialogOpen: false,
                        get componentMap() {
                            return {
                                barrios: this.PublicLayerBarrios,
                                deals: this.PublicLayerDeals,
                                geojson: this.PublicLayerGeoJson,
                            }
                        },
                        importComponent() {
                    
                            return import('/js/public_map.js').then((module) => {
                                console.log('PublicMapMoldules', module);
                                //Alpine.store('public_maps',()=>new module.createPublicMapStore())
                                //this.$store.public_maps.$store.negocios=this.$store.negocios;
                                //this.$store.public_maps.updateProperties([]).refreshSavedMaps();
                                //globalThis.$store.public_maps=this.$store.public_maps
                    
                    
                                const { PublicLayerBarrios, PublicLayerDeals, PublicLayerGeoJson, PublicMapFrameData } = module.PublicMapComponents
                                globalThis.PublicMapComponents=module.PublicMapComponents
                                Alpine.data('PublicLayerDeals', PublicLayerDeals);
                                Alpine.data('PublicLayerGeoJson', PublicLayerGeoJson);
                                Alpine.data('PublicMapFrameData', PublicMapFrameData);
                                Alpine.data('PublicLayerBarrios', PublicLayerBarrios);
                                this.PublicLayerDeals = PublicLayerDeals;
                                this.PublicLayerGeoJson = PublicLayerGeoJson
                                this.PublicMapFrameData = PublicMapFrameData
                                this.PublicLayerBarrios = PublicLayerBarrios
                                this.componentsReady = true;
                                globalThis.DynamicLoader = this
                                setTimeout(()=>{
                                    globalThis.gmap.setOptions({maxZoom:13})
                                    globalThis.gmap.setZoom(17);
                                    setTimeout(()=>{
                                        globalThis.gmap.setZoom(17);
                                    },4000)
                                
                                },4000)
                                
                            });
                        },
                    }">

                        <template x-if="componentsReady">

                            <div class="map_outer_container" style="text-align: center" x-data="PublicMapFrameData({ extent, codigo_interno })">

                                <div class="  -ml-4 w-[60%] max-w-[55vw]   md:max-w-[500px] md:w-[45%]   pl-0" id="search_contextual">
                                
                                <template x-teleport="#search_contextual">
                                    <div class="flex-nowrap input-group justify-content-end w-full" id="searchCampo"
                                        x-init="setTimeout(() => document.querySelector('#search_contextual').append(document.querySelector('#searchCampo')), 1000)">
                                        <span class="input-group-text h-24-em"><i class="fa fa-search"></i></span>
                                        <input type="text" x-model="$store.negocios.searchValue" x-ref="searchInput"
                                            @input.debounce="()=>{
        const term=String(searchValue).normalize('NFD').replace(/\p{Diacritic}/gu,'').trim()
        search(term)
    }"
                                            class="border border-color-gray border-opacity-10 flex-fill focus:tw-outline-none px-2 py-1 rounded w-auto"
                                            placeholder="Buscar propiedad">

                                    </div>
                                </template>
                            </div>
                                <div class="w-full flex flex-col items-center justify-center border gmap   "
                                    :class="{
                                        'controls_closed': !mapDialogOpen,
                                    }"
                                    x-ref="map_container" id="map_container">
                                </div>


                                <div id="map_controls" style="transition: left 0.4s ease; " x-show="full_map"
                                    x-data="{
                                    
                                        layers_and_components: [],
                                        init() {
                                    
                                            globalThis.mapControls = this;
                                            this.layers_and_components = this.$store.public_maps.layer_array.map(layer => {
                                                return {
                                                    ...layer,
                                                    component: Alpine.data(layer.type === 'deals' ? 'PublicLayerDeals' : layer.type === 'geojson' ? 'PublicLayerGeoJson' : 'PublicLayerBarrios')
                                                }
                                            });
                                            console.log({ layers_and_components: this.layers_and_components })
                                    
                                    
                                        }
                                    
                                    }"
                                    :class="{
                                        'pl-[15px]': mapDialogOpen && googleReady,
                                        'pr-[5px]': mapDialogOpen && googleReady,
                                        '-left-[240px]': !mapDialogOpen,
                                        '-left-[270px]': !googleReady,
                                        '-left-[5px]': mapDialogOpen && googleReady,
                                    }"
                                    class="bg-white max-w-[400px] min-w-[270px] shadow-lg border min-h-[400px] pl-4 pt-2                absolute">


                                    <template
                                        x-for="({checked, slug_name,url, name, path, layer_options, criteria,type},index) in                                         $store.public_maps.layer_array"
                                        :key="slug_name">
                                        <span class="flex flex-col map_collapsible">
                                            <div x-id="['map-layer']" x-data="componentMap[type]({ index, checked, slug_name, name, path, layer_options, criteria }, comunas)"
                                                class="border accordion flex flex-col ">

                                                <div class="accordion-header  bg-gray-50 flex py-1 justify-start map_controls_layer"
                                                    x-init="slug_name = slug_name"
                                                    :style="'color:' + (length ? layer_options.strokeColor : '#aaa')"
                                                    x-on:click="()=>{
                                                        filters_open=!filters_open
                                                    }">
                                                    <input :name="$id('map-layer')" type="checkbox"
                                                        class="form-check-input  mr-2"
                                                        x-on:click.stop="layer_options.checked=!layer_options.checked"
                                                        x-model="layer_options.checked"
                                                        :checked="layer_options.checked" />

                                                    <i class="mr-2 collapsible_tooltip fontello"
                                                        :class="{
                                                            [layer_options.className]: true
                                                        }"
                                                        x-tooltip.theme.light="length+' registros'"></i><label
                                                        style="transform: translate(0,1px)" :for="$id('map-layer')"
                                                        x-text="name" class=""></label>
                                                </div>

                                            </div>


                                        </span>
                                    </template>
                                    <div class="absolute h-full w-[30px] bg-gray-200 top-0 hover:bg-gray-300 z-10 "
                                        :class="{
                                            'w-[30px]': !mapDialogOpen,
                                            'w-[20px]': mapDialogOpen,
                                            'right-0': !mapDialogOpen,
                                            'left-0': mapDialogOpen
                                        }"
                                        style="    border: 1px solid #aaa;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            left:${mapDialogOpen ? '0' : 'unset'};
                            font-size: 1.9em;"
                            
                                        x-on:click="()=>{
                            $el.parentElement.classList.toggle('-left-[220px]')
                            console.log({mapDialogOpen})
                            mapDialogOpen = !mapDialogOpen
                        }">
                                        <i class="fas "
                                            :class="{
                                                'fa-chevron-right': !mapDialogOpen,
                                                'fa-chevron-left': mapDialogOpen,
                                            }"></i>
                                    </div>

                                </div>


                        </template>


                    </div>
            </div>


            </template>
            </div>
            </article>
            </div>
            <!-- end container -->
        </section>
        <!-- ========== section end ========== -->

        <!-- ========== footer start =========== -->

        <!-- ========== footer end =========== -->


    </main>
    <!-- ======== main-wrapper end =========== -->

 



    <span id="store" class="hidden invisible" x-data="{
        init() {
    
    
    
            let keys = JSON.parse(JSON.stringify([...Object.keys($store)]))
            const globalStore = {};
            for (let key of Object.values(keys)) {
    
                Object.defineProperty(globalStore, key, {
                    enumerable: true,
                    __proto__: null,
                    get() {
                        return Alpine.store(key)
                    }
                })
            }
            globalThis.$store = globalStore;
            Object.defineProperty(globalThis, '$store', {
                __proto__: null,
                enumerable: true,
                get() {
                    return globalStore;
                }
            })
    
    
        }
    }">
    </span>
    <script>
             
        function maploaded() {
            console.timerInfo('maploaded');
            
       
        Alpine.start()
    }
        //[...document.querySelectorAll('iframe')].forEach(i=>i.())
    </script>
    <script
    async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAAnmNtArAHn42aA9BEyiuGDN2Y1J4lhV8&callback=maploaded"
></script>

</body>

</html>
