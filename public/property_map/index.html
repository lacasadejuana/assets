<!DOCTYPE html>
<html lang="en">
	<head>
		<script src="./js/init_public_map.js"></script>
	</head>

	<body>
		<gmp-map
			style="height: 600px"
			id="custom_element_map"
			center="-33.398,-70.58"
			:bounds="bounds"
			zoom="15"
			style="diplay: block !important; min-height: 300px"
			map-id="8f541b0e0f5f6c31"
			x-data="{
			 
            codigo_interno: null,
            extent: null,
			bounds: null,
            init() {
				
                this.importComponent();
                let qs = new URL(location.href)
				if (qs.searchParams.get('extent')) {
        
					this.extent = qs.searchParams.get('extent')

					// this.full_map=false;
					this.full_map = false;
					this.$store.public_maps.full_map = this.full_map;
					this.$store.public_maps.extent=this.extent;
				}
                if (qs.searchParams.get('codigo_interno')) {
                    this.codigo_interno = qs.searchParams.get('codigo_interno')
					this.$store.public_maps.codigo_interno = this.codigo_interno;
                }
              
        
            },
            full_map: false,
            get componentMap() {
                return {
                    barrios: this.PublicMapComponents.PublicLayerBarrios,
                    deals: this.PublicMapComponents.PublicLayerDeals,
                    geojson: this.PublicMapComponents.PublicLayerGeoJson,
        
                }
            },
            componentsReady: false,
            PublicMapComponents: {},
            importComponent() {
        
                return import('./js/property_map.js').then((module) => {
                    console.log('PublicMapMoldules', module);

        
                    const { PublicLayerBarrios, PublicLayerDeals, PublicLayerGeoJson, PublicMapFrameData, PublicLayerBarriosWebGL } = module.PublicMapComponents
                    this.PublicMapComponents = module.PublicMapComponents
        
                    Object.entries(module.PublicMapComponents).forEach(([name, ctor]) => {
                        this[name] = ctor
                        Alpine.data(name, ctor)
                    });
        
                    this.componentsReady = true;
                    globalThis.DynamicLoader = this
                });
        
            } 
        }"
		>
			<gmp-advanced-marker position="-33.398,-70.58" title=""></gmp-advanced-marker>
			<article class="outer_container" id="barebone_container">
				<!--<link rel="stylesheet" href="./css/app.css" />-->
				<div class="w-full">
					<template x-if="componentsReady">
						<div
							class="map_outer_container"
							style="text-align: center"
							x-data="PublicMapFrameData({extent,codigo_interno})"
						>
							<div
								class="w-full flex flex-col items-center justify-center border gmap"
								:class="{
                   'controls_closed': !mapDialogOpen,
               }"
								x-ref="map_container"
								id="map_container"
							></div>

							<template
								x-for="({checked, slug_name,url, name, path, layer_options, criteria,type},index) in  $store.public_maps.layer_array"
								:key="slug_name"
							>
								<div
									x-id="['map-layer']"
									x-data="componentMap[type]({ index, checked, slug_name, name, path, layer_options, criteria }, comunas)"
									class="border accordion flex flex-col"
								></div>
							</template>
						</div>
					</template>
				</div>
			</article>
			<style id="style_css">
				<
			</style>
			<template id="css_map">
				<style id="css_style"></style>
			</template>

			<script>
				const custom_element_map = document.querySelector('#custom_element_map');

				setTimeout(() => {
					customElements.whenDefined(custom_element_map.localName).then(async mapElement => {
						//let {map,shadowRoot}=mapElement
						console.warn({ mapElement });
						//Alpine.initTree(map)
					});
				}, 400);
				const advancedMarkers = document.querySelectorAll(
					'#custom_element_map gmp-advanced-marker'
				);
				for (const advancedMarker of advancedMarkers) {
					customElements.whenDefined(advancedMarker.localName).then(async () => {
						Alpine.store('public_maps').customElementsMap = advancedMarker.map;
						advancedMarker.map.setOptions({ streetViewControl: false, mapTypeControl: false });
						console.timerInfo('got reference to custom element map');
						//Alpine.initTree(advancedMap)
						let styleTag2 = document.createElement('style');
						styleTag2.textContent = `
							@import url('./css/app.css')
							
							
						`;

						advancedMarker.map.controls[google.maps.ControlPosition.TOP_RIGHT].push(styleTag2);

						advancedMarker.addEventListener('gmp-click', async () => {
							console.info('gmp-click');
							const { InfoWindow } = await google.maps.importLibrary('maps');
							const infoWindow = new InfoWindow({
								content: advancedMarker.title,
							});
							infoWindow.open({
								anchor: advancedMarker,
							});
						});
					});
				}
				console.timerInfo('DOMContentLoaded');

				function cargamos() {
					console.trace('cagamos');
				}

				console.timerInfo('start: negocio common footer');

				globalThis.googleMapsOptions = {
					apiKey: 'AIzaSyAAnmNtArAHn42aA9BEyiuGDN2Y1J4lhV8',
					version: 'beta',
					region: 'CL',
					language: 'es',
					mapId: '8f541b0e0f5f6c31',
					libraries: ['places', 'localContext'],
				};
				const { campos_busqueda = [], default_columns = [] } = globalThis;

				const contactosArray = '';
				globalThis.backendPaginator = {
					has_take: true,
					count: 129,
					next_page_url: null,
					first_page_url: 'https:\/\/assets.juana.house\/api\/negocios',
					last_page_url: 'https:\/\/assets.juana.house\/api\/negocios',
					current_page: 1,
					from: 1695628584,
					cursor: 1695628584,
					last_page: 1,
					max_id: null,
					min_id: null,
					path: 'https:\/\/negocioslocal.juana.house\/api\/maps\/publicaciones?',
					per_page: 350,
					prev_page_url: null,
					query: { limit: 350, take: 1, api_base_path: '\/api\/maps\/publicaciones', total: 250 },
					request_id: 'dcdcbe64-d493-4c3d-8321-af0c2759be62',
					current_filter_id: null,
					to: 130,
					total: 129,
					links: [
						{ url: null, label: '&laquo; Anterior', active: false },
						{ url: null, label: '&laquo; Siguiente', active: false },
					],
					data: [],
				};
			</script>

			<span
				id="store"
				class="hidden invisible"
				x-data="{
    init() {



        let keys = JSON.parse(JSON.stringify([...Object.keys($store)]))
        const globalStore = {};
        for (let key of Object.values(keys)) {

            Object.defineProperty(globalStore, key, {
                enumerable: true,
                __proto__: null,
                get() {
                    return Alpine.store(key)
                }
            })
        }
        globalThis.$store = globalStore;
        Object.defineProperty(globalThis, '$store', {
            __proto__: null,
            enumerable: true,
            get() {
                return globalStore;
            }
        })


    }
}"
			>
			</span>
			<script>
				function maploaded() {
					console.timerInfo('maploaded');
					Alpine.start();
				}
			</script>
			<script
				async
				src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAAnmNtArAHn42aA9BEyiuGDN2Y1J4lhV8&callback=maploaded"
			></script>
		</gmp-map>
	</body>
</html>
